{
  "$schema": "https://json-schema.org/draft/2020-12/schema",
  "$id": "https://github.com/sankarshanmukhopadhyay/trqp-conformance-suite/blob/main/docs/evidence_bundle.schema.json",
  "title": "TRQP Conformance Evidence Bundle Descriptor",
  "description": "Schema for a machine-readable descriptor of a TRQP conformance evidence bundle.",
  "type": "object",
  "required": [
    "bundle_version",
    "run",
    "artifacts"
  ],
  "properties": {
    "bundle_version": {
      "type": "string",
      "pattern": "^\\d+\\.\\d+\\.\\d+(-[A-Za-z0-9][A-Za-z0-9\\.\\-_]*)?$",
      "description": "Version of the evidence bundle format."
    },
    "run": {
      "type": "object",
      "required": [
        "test_run_id",
        "profile_id",
        "sut",
        "started_at",
        "ended_at",
        "tool"
      ],
      "properties": {
        "test_run_id": {
          "type": "string",
          "minLength": 1
        },
        "profile_id": {
          "type": "string",
          "minLength": 1
        },
        "sut": {
          "type": "object",
          "required": [
            "endpoint"
          ],
          "properties": {
            "endpoint": {
              "type": "string",
              "minLength": 1
            },
            "version": {
              "type": "string"
            },
            "state_reference": {
              "type": "string",
              "minLength": 1
            }
          },
          "additionalProperties": true
        },
        "started_at": {
          "type": "string",
          "format": "date-time"
        },
        "ended_at": {
          "type": "string",
          "format": "date-time"
        },
        "tool": {
          "type": "object",
          "required": [
            "name",
            "version"
          ],
          "properties": {
            "name": {
              "type": "string",
              "minLength": 1
            },
            "version": {
              "type": "string",
              "minLength": 1
            },
            "commit": {
              "type": "string"
            },
            "build": {
              "type": "string"
            }
          },
          "additionalProperties": true
        },
        "environment": {
          "type": "object",
          "description": "Optional environment metadata (CI, OS, Python version, network mode, etc.).",
          "additionalProperties": true
        }
      },
      "additionalProperties": true
    },
    "artifacts": {
      "type": "object",
      "required": [
        "run_json",
        "verdicts",
        "manifest",
        "cases_dir"
      ],
      "properties": {
        "run_json": {
          "type": "string",
          "minLength": 1
        },
        "verdicts": {
          "type": "string",
          "minLength": 1
        },
        "manifest": {
          "type": "string",
          "minLength": 1
        },
        "signature": {
          "type": "string",
          "minLength": 1
        },
        "signing_public_key": {
          "type": "string",
          "minLength": 1
        },
        "bundle_zip": {
          "type": "string",
          "minLength": 1
        },
        "cases_dir": {
          "type": "string",
          "minLength": 1
        },
        "cases": {
          "type": "array",
          "items": {
            "type": "object",
            "required": [
              "case_id",
              "transcript_path"
            ],
            "properties": {
              "case_id": {
                "type": "string",
                "minLength": 1
              },
              "transcript_path": {
                "type": "string",
                "minLength": 1
              },
              "request_path": {
                "type": "string"
              },
              "response_path": {
                "type": "string"
              },
              "notes": {
                "type": "string"
              }
            },
            "additionalProperties": true
          }
        }
      },
      "additionalProperties": true
    },
    "hashes": {
      "type": "object",
      "description": "Optional mapping of artifact path -> hash. Typically redundant with manifest.json but allowed for convenience.",
      "additionalProperties": {
        "type": "string"
      }
    }
  },
  "additionalProperties": true,
  "allOf": [
    {
      "if": {
        "properties": {
          "run": {
            "properties": {
              "profile_id": {
                "pattern": "(?i)high[-_ ]?assurance"
              }
            },
            "required": [
              "profile_id"
            ]
          }
        }
      },
      "then": {
        "properties": {
          "run": {
            "properties": {
              "sut": {
                "required": [
                  "state_reference"
                ]
              }
            }
          },
          "artifacts": {
            "required": [
              "signature"
            ]
          }
        }
      }
    }
  ]
}
